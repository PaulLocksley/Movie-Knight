@using Movie_Knight.Models
@model Movie_Knight.Pages.UserComparison
@{ ArgumentNullException.ThrowIfNull(Model); }

<div id="userAnalysis" class="text-gray-200">
@await Html.PartialAsync("_TabNavigation", "table")

<div id="tab-content">
    <!-- Table Tab Content -->
    <div id="table-tab" class="tab-pane">
        @if (Model.SharedMovies is {} movies)
        {
            <div class="bg-slate-700 rounded-sm mb-2 mt-8 p-2">
            @if( Model.ComparisonUsers is {} infoUsers){
                @foreach(var user in infoUsers){
                    <p> <b> @user.username </b> difference to group average: @Model.UserDeltas[user.username] </p>
                }
            }
            
                        <span class="text-sm @(Model.GroupPercentile >= 75 ? "text-green-400" : 
                                              Model.GroupPercentile >= 50 ? "text-yellow-400" : 
                                              Model.GroupPercentile >= 25 ? "text-orange-400" : "text-red-400")">
                            This group is in the @Model.GroupPercentile.ToString("F1")th percentile for rating agreement@(Model.GroupPercentile >= 90 ? "!!!" : Model.GroupPercentile >= 75 ? "!" : 
                                              Model.GroupPercentile >= 50 ? "" : 
                                              Model.GroupPercentile >= 25 ? " :(" : " :'(")
                            </span>
            </div>


            <table class="w-full table-auto border-collapse bg-slate-800 rounded-lg overflow-hidden shadow-lg">
            @if (Model.ComparisonUsers is {} users)
            {
                <tr class="bg-slate-700 font-bold text-xl">
                    <th class="text-left py-4 px-6 w-1/4 border-b border-slate-600">Name</th>
                    @foreach (var user in users)
                    {
                        <th class="text-center py-4 px-3 border-b border-slate-600">@user.username</th>
                    }
                    <th class="text-center py-4 px-3 border-b border-slate-600">Group Average</th>
                    <th class="text-center py-4 px-3 border-b border-slate-600">Difference</th>
                    @if (Model.SortOrder == SortType.Popularity || Model.SortOrder == SortType.PopularityDesc)
                    {
                        <th class="text-center py-4 px-3 border-b border-slate-600"># of ratings</th>
                    }
                    <th class="text-center py-4 px-3 border-b border-slate-600 w-16"><div class="dropdown">
                                    <button class="dropbtn bg-cyan-500 hover:bg-cyan-300 rounded-sm"><img src="img\sort.svg" alt="Sort" width="36px"/></button>
                                    <div class="dropdown-content bg-cyan-500 hover:bg-cyan-300 text-gray-950">
                                        @foreach (var viewSortType in Enum.GetValues(typeof(SortType)).Cast<SortType>())
                                        {
                                            <div class="dropdown-link" 
                                                 hx-get="/UserComparison?@(ViewContext.HttpContext.Request.QueryString.Value?.Replace("sortString=" + Model.SortOrder, "") ?? "")&sortString=@viewSortType" 
                                                 hx-target="#userAnalysis">
                                                @viewSortType
                                            </div>
                                        }
                                    </div>
                                </div></th>
                </tr>
                @foreach (var movie in movies)
                {
                    <tr onclick="showHidenRow('info-@movie.movieData.id')" class="text-lg border-b border-slate-600 hover:bg-slate-700 transition-colors duration-200 cursor-pointer">
                        <td class="py-3 px-6 border-r border-slate-600">
                            <a href="https://letterboxd.com/film/film:@movie.movieData.id/" class="text-blue-400 hover:text-blue-300 font-medium">
                                @movie.movieData.name.Split("-").Select(x =>
                                    x[..1].ToUpper() + x[1..]).Aggregate("", (x, y) => (x + " " + y))
                            </a>
                        </td>

                        @foreach (var user in users)
                        {
                            <td class="py-3 px-3 text-center border-r border-slate-600 font-semibold">@user.userList[movie.Item1.id].ToString()</td>
                        }
                        <td class="py-3 px-3 text-center border-r border-slate-600 font-medium">@Math.Round(movie.Item2,2)</td>
                        <td class="py-3 px-3 text-center border-r border-slate-600">@movie.Item3</td>
                        @if (Model.SortOrder == SortType.Popularity || Model.SortOrder == SortType.PopularityDesc)
                        {
                            <td class="py-3 px-3 text-center border-r border-slate-600">@movie.movieData.RatingCount.ToString()</td>
                        }
                        <td class="py-3 px-3 text-center">
                            <img src="img/expand_more.svg" id="img-info-@movie.movieData.id" alt="Expand" class="mx-auto"/>
                        </td>
                    </tr>
                    <tr id="info-@movie.movieData.id" class="hidden-row">
                    </tr>
                }
            }
            </table>
        }
    </div>

    <!-- Graphs Tab Content -->
    <div id="graphs-tab" class="tab-pane"
            style="display: none;"
            hx-trigger="load" hx-get="/_Graph@(ViewContext.HttpContext.Request.QueryString)" >
        <p>loading</p>
    </div>

    <!-- Watch List Tab Content -->
    <div id="watchlist-tab" class="tab-pane"
    style="display: none;"
    hx-trigger="load" hx-get="/_WatchList@(ViewContext.HttpContext.Request.QueryString)" >
    </div>

    <!-- Recommendations Tab Content -->
    <div id="recommendations-tab" class="tab-pane" style="display: none;">
        <h3 class="text-xl">Recommendations:</h3>
        <p>Recommendations are based on the following criteria:</p>
        <ul class="list-disc list-inside">
            <li>No users have seen the movie</li>
            <li>It is related to at least <b class="font-semibold">two</b> movies that the group has given a mean rating of 8 or above</li>
        </ul>
        @if (Model.MovieRecs.Count == 0)
        {
            <h2>Congrats, I don't have any recommendations for you. </h2>
        }
        else
        {
            <table class="w-full table-auto border-collapse bg-slate-800 rounded-lg overflow-hidden shadow-lg">
                <tr class="bg-slate-700 font-bold text-xl">
                    <th scope="col" class="text-left py-4 px-6 w-1/2 border-b border-slate-600">Title</th>
                    <th scope="col" class="text-left py-4 px-6 w-1/4 border-b border-slate-600">Genre</th>
                    <th scope="col" class="text-center py-4 px-6 w-1/4 border-b border-slate-600">Duration (mins)</th>
                </tr>
                @foreach (var movie in Model.MovieRecs.OrderBy(x => x.attributes.Where(a => a.role == "genre").Aggregate("", (_, y) => "" + y.name)))
                {
                    <tr class="border-b border-slate-600 hover:bg-slate-700 transition-colors duration-200">
                        <th scope="row" class="text-left py-3 px-6 border-r border-slate-600">
                            <a class="text-blue-400 hover:text-blue-300 font-medium" href="https://letterboxd.com/film/film:@movie.id/">
                                @movie.name.Split("-").Select(x =>
                                        x[..1].ToUpper() + x[1..]).Aggregate("", (x, y) => (x + " " + y))
                            </a>
                        </th>
                        <td class="py-3 px-6 border-r border-slate-600">@movie.attributes.Where(x => x.role == "genre").Aggregate("", (_, y) => "" + y.name)</td>
                        <td class="py-3 px-6 text-center">@movie.duration</td>
                    </tr>
                }
            </table>
        }
    </div>
</div>
</div>

